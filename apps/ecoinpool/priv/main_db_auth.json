{
   "_id": "_design/auth",
   "language": "javascript",
   "validate_doc_update": "function(newDoc, oldDoc, userCtx) {\n  switch ((newDoc._deleted ? oldDoc.type : newDoc.type)) {\n    case 'configuration':\n      if (userCtx.roles.indexOf('_admin') === -1)\n        throw({forbidden: 'Only admins may edit the root configuration'});\n      break;\n    case 'sub-pool':\n      if (userCtx.roles.indexOf('_admin') === -1)\n        throw({forbidden: 'Only admins may edit Subpool configurations'});\n      break;\n    case 'worker':\n      if (!newDoc._deleted) {\n        if (newDoc.sub_pool_id === undefined)\n          throw({forbidden: 'The sub_pool_id field is missing'});\n        if (typeof newDoc.name != 'string' || newDoc.name == '')\n          throw({forbidden: 'The name field is missing or invalid'});\n        if (userCtx.roles.indexOf('_admin') === -1) {\n          if (oldDoc !== null) {\n            if (oldDoc.sub_pool_id != newDoc.sub_pool_id)\n              throw({forbidden: 'You cannot change the sub_pool_id field'});\n            else if (oldDoc.user_id != newDoc.user_id)\n              throw({forbidden: 'You cannot change the user_id field'});\n          }\n          if (typeof newDoc.user_id !== 'number')\n            throw({forbidden: 'user_id must be a number'});\n          if (userCtx.roles.indexOf('user_id:' + newDoc.sub_pool_id + ':' + newDoc.user_id) === -1)\n            throw({forbidden: 'You may only create or update your own workers'});\n          if (newDoc.name != userCtx.name && (newDoc.name.indexOf('_') === -1 || newDoc.name.substr(0, newDoc.name.indexOf('_')) != userCtx.name))\n              throw({forbidden: 'Worker names must have the format \"username[_suffix]\"'});\n        }\n      }\n      else if (userCtx.roles.indexOf('_admin') === -1) {\n        if (userCtx.roles.indexOf('user_id:' + oldDoc.sub_pool_id + ':' + oldDoc.user_id) === -1)\n            throw({forbidden: 'You may only delete your own workers'});\n      }\n      break;\n    default:\n      throw({forbidden: 'Invalid document type'});\n  }\n}"
}